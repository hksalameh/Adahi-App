<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الأضاحي</title>
    <style>
        /* CSS styles remain the same as your last provided version */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;500;700&display=swap');
        body { font-family: 'Noto Kufi Arabic', 'Tajawal', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #2c3e50; line-height: 1.7; font-size: 16px; }
        .page-container { padding: 20px; }
        .container { max-width: 950px; margin: 25px auto; background-color: #ffffff; padding: 30px 35px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.07); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 35px; font-size: 2.5em; font-weight: 700; }
        h2 { color: #34495e; text-align: center; margin-top: 35px; margin-bottom: 30px; border-bottom: 2px solid #eaecee; padding-bottom: 12px; font-size: 2em; font-weight: 700; }
        #dataEntrySection form label, #loginSection form label { font-size: 1.1em; color: #34495e; margin-bottom: 8px; font-weight: 500; display: block; }
        #loginSection .remember-me-label { font-size: 1em; font-weight: normal; margin-right: 5px; }
        #loginSection input[type="checkbox"] { vertical-align: middle; margin-left: 5px; transform: scale(1.1); }
        #dataEntrySection form input[type="text"], #dataEntrySection form input[type="tel"], #dataEntrySection form select, #loginSection form input[type="text"], #loginSection form input[type="password"] { font-size: 1.1em; padding: 12px; border: 1px solid #bcccdc; background-color: #fcfdff; border-radius: 6px; width: 100%; box-sizing: border-box; }
        #dataEntrySection form textarea#portionDetails { font-size: 1.1em; padding: 10px; border: 1px solid #bcccdc; background-color: #fcfdff; border-radius: 6px; width: 100%; box-sizing: border-box; min-height: 60px; height: 80px; resize: vertical; }
        #dataEntrySection form input[type="text"]:focus, #dataEntrySection form input[type="tel"]:focus, #dataEntrySection form textarea:focus, #dataEntrySection form select:focus, #loginSection form input[type="text"]:focus, #loginSection form input[type="password"]:focus { border-color: #5dade2; box-shadow: 0 0 0 0.2rem rgba(41,128,185,.25); outline: none; }
        #dataEntrySection form textarea#portionDetails:focus { border-color: #5dade2; box-shadow: 0 0 0 0.2rem rgba(41,128,185,.25); outline: none; }
        #dataEntrySection form div, #loginSection form div:not(.remember-me-group) { margin-bottom: 20px; }
        #loginSection .remember-me-group { margin-bottom: 15px; text-align: right;}
        #loginSection form { max-width: 400px; margin-left: auto; margin-right: auto; }
        #loginSection form label { text-align: right; }
        #dataEntrySection .radio-group-label { font-size: 1.1em; margin-bottom: 10px;}
        #dataEntrySection input[type="radio"] + label { font-weight: normal; font-size: 1.05em; margin-right: 15px; margin-left: 5px; color: #566573; display: inline-flex; align-items: center; }
        #dataEntrySection input[type="radio"] { margin-left: 8px; vertical-align: middle; width: auto; transform: scale(1.1); }
        button, input[type="submit"] { padding: 12px 25px; background-color: #3498db; color: white; border: none; cursor: pointer; margin-top: 10px; margin-right: 10px; border-radius: 6px; font-size: 1.1em; font-weight: 500; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover, input[type="submit"]:hover { background-color: #2980b9; } button:active, input[type="submit"]:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #adahiForm button[type="submit"] { background-color: #27ae60; min-width: 180px; font-weight: 700; font-size: 1.15em; padding: 13px 30px; }
        #adahiForm button[type="submit"]:hover { background-color: #229954; }
        #logoutButton { background-color: #e74c3c; font-size: 1.1em; padding: 12px 25px;}
        #logoutButton:hover { background-color: #c0392b; }
        #adminActions { text-align: center; margin-bottom: 25px; }
        #adminActions button { background-color: #7f8c8d; font-size: 1em; padding: 10px 20px; box-shadow: none; margin-bottom: 5px; }
        #adminActions button:hover { background-color: #6c7a7b; }
        /* Removed input style from adminActions as the input field is removed */
        #sacrificesTableBody button { font-size: 0.9em; padding: 6px 12px; margin-right: 5px; box-shadow: none; border-radius: 4px; }
        #sacrificesTableBody button.delete-btn { background-color: #e74c3c; }
        #sacrificesTableBody button.delete-btn:hover { background-color: #c0392b; }
        .hidden-field, .admin-section, .user-section, .user-data-section { display: none; } hr { margin: 40px 0; border: 0; border-top: 1px solid #bdc3c7; } #statusMessage, #authStatus { margin-top: 20px; padding: 14px; border-radius: 6px; font-weight: 500; font-size: 1.1em; } .success { background-color: #d0f0c0; color: #228B22; border: 1px solid #a0d0a0; } .error { background-color: #fddfdf; color: #D8000C; border: 1px solid #fccfcf; } table { width:100%; margin-top: 25px; border-collapse: separate; border-spacing: 0; box-shadow: 0 3px 8px rgba(0,0,0,0.06); border-radius: 8px; overflow: hidden; } th, td { border-bottom: 1px solid #d3d9e0; padding: 14px 18px; text-align: right; vertical-align: middle; font-size: 1.05em; } td { border-left: 1px solid #d3d9e0; } td:first-child { border-left: none; } th { background-color: #eaf0f7; font-weight: 700; color: #2c3e50; font-size: 1.1em; border-top: 1px solid #d3d9e0;} tbody tr:last-child td { border-bottom: none; } #sacrificesTableBody tr:nth-child(even), #userSacrificesTableBody tr:nth-child(even) { background-color: #fbfcfd; } #sacrificesTableBody tr:hover, #userSacrificesTableBody tr:hover { background-color: #e6f3ff; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <h1>موقع تسجيل الأضاحي</h1>
            <div id="authStatus"></div>
            <div id="loginSection">
                <h2>تسجيل الدخول</h2>
                <form id="loginForm">
                    <div><label for="usernameInput">رقم/اسم المستخدم:</label><input type="text" id="usernameInput" name="usernameInput" required></div>
                    <div><label for="passwordInput">كلمة المرور:</label><input type="password" id="passwordInput" name="passwordInput" required></div>
                    <div class="remember-me-group">
                        <input type="checkbox" id="rememberMe" name="rememberMe" checked>
                        <label for="rememberMe" class="remember-me-label">تذكرني</label>
                    </div>
                    <button type="submit">دخول</button>
                </form>
            </div>
            <button id="logoutButton" class="hidden-field">تسجيل الخروج</button>
            <hr class="hidden-field" id="hrAfterLogout">
            <div id="dataEntrySection" class="user-section"> <hr>
                <h2>تسجيل أضحية/تبرع جديد</h2>
                <form id="adahiForm">
                    <div><label for="donorName">اسم المتبرع:</label><input type="text" id="donorName" name="donorName" required></div>
                    <div><label for="sacrificeFor">الأضحية عن (اسم الشخص/الجهة):</label><input type="text" id="sacrificeFor" name="sacrificeFor" required></div>
                    <div><label class="radio-group-label">هل يريد الحضور؟</label><input type="radio" id="wantsToAttendYes" name="wantsToAttend" value="yes"><label for="wantsToAttendYes">نعم</label><input type="radio" id="wantsToAttendNo" name="wantsToAttend" value="no" checked><label for="wantsToAttendNo">لا</label></div>
                    <div><label for="phoneNumber">رقم الهاتف (اختياري):</label><input type="tel" id="phoneNumber" name="phoneNumber"></div>
                    <div><label class="radio-group-label">هل يريد جزءًا من الأضحية؟</label><input type="radio" id="wantsPortionYes" name="wantsPortion" value="yes"><label for="wantsPortionYes">نعم</label><input type="radio" id="wantsPortionNo" name="wantsPortion" value="no" checked><label for="wantsPortionNo">لا</label></div>
                    <div id="portionDetailsDiv" class="hidden-field"><label for="portionDetails">ماذا يريد من الأضحية؟</label><textarea id="portionDetails" name="portionDetails" rows="3"></textarea></div>
                    <div id="addressFieldDiv" class="hidden-field"><label for="address">العنوان (لتوصيل الجزء إذا اختار "نعم"):</label><input type="text" id="address" name="address"></div>
                    <div><label class="radio-group-label">هل تم الدفع؟</label><input type="radio" id="paymentDoneYes" name="paymentDone" value="yes"><label for="paymentDoneYes">نعم</label><input type="radio" id="paymentDoneNo" name="paymentDone" value="no" checked><label for="paymentDoneNo">لا</label></div>
                    <div id="paymentDetailsDiv" class="hidden-field"><div><label for="receiptBookNumber">رقم الدفتر:</label><input type="text" id="receiptBookNumber" name="receiptBookNumber"></div><div><label for="receiptNumber">رقم السند:</label><input type="text" id="receiptNumber" name="receiptNumber"></div></div>
                    <div><label for="assistanceFor">لمن المساعدة (توزيع اللحم)؟</label><select id="assistanceFor" name="assistanceFor"><option value="inside_ramtha">داخل الرمثا</option><option value="gaza_people">لأهل غزة</option><option value="for_himself">لنفسه (إذا كان سيأخذها كاملة)</option></select></div>
                    <div>
                        <label class="radio-group-label">هل تم إحضارها بواسطة شخص آخر (وسيط)؟</label>
                        <input type="radio" id="broughtByOtherYes" name="broughtByOther" value="yes"><label for="broughtByOtherYes">نعم</label>
                        <input type="radio" id="broughtByOtherNo" name="broughtByOther" value="no" checked><label for="broughtByOtherNo">لا</label>
                    </div>
                    <div id="broughtByOtherNameDiv" class="hidden-field">
                        <label for="broughtByOtherName">اسم الشخص الذي أحضرها:</label>
                        <input type="text" id="broughtByOtherName" name="broughtByOtherName">
                    </div>
                    <div style="text-align: center;"><button type="submit">تسجيل البيانات</button></div>
                </form>
                <div id="statusMessage"></div><hr>
            </div>
            <div id="userDataViewSection" class="user-data-section">
                <h2>تسجيلاتك الحالية</h2>
                <p id="userLoadingMessage">جاري تحميل تسجيلاتك...</p>
                <table id="userSacrificesTable" border="1">
                    <thead>
                        <tr><th>م.</th><th>اسم المتبرع</th><th>الأضحية عن</th><th>أحضرت بواسطة آخر؟</th><th>اسم الوسيط</th><th>تاريخ التسجيل</th><th>الحالة</th></tr>
                    </thead>
                    <tbody id="userSacrificesTableBody"></tbody>
                </table><hr>
            </div>
            <div id="adminViewSection" class="admin-section">
                <h2>سجلات الأضاحي المسجلة</h2>
                <div id="adminActions">
                    <button id="filterPending">عرض "لم تدخل بعد" فقط</button>
                    <button id="filterEntered">عرض "تم الإدخال" فقط</button>
                    <button id="filterAll">عرض الكل</button>
                    <hr style="margin: 15px 0;">
                    <button id="exportAllToCsvButton">تصدير كل البيانات (CSV)</button>
                    <button id="exportAllUsersSeparateCsvButton" style="margin-top:10px;">تصدير بيانات كل مستخدم بملف منفصل (CSV)</button>
                </div>
                <div id="sacrificesTableContainer"><p id="loadingMessage">جاري تحميل البيانات...</p>
                    <table id="sacrificesTable" border="1">
                        <thead>
                            <tr><th>م.</th><th>اسم المتبرع</th><th>الأضحية عن</th><th>يريد الحضور</th><th>رقم الهاتف</th><th>يريد جزءًا</th><th>تفاصيل الجزء</th><th>العنوان</th><th>تم الدفع</th><th>رقم الدفتر</th><th>رقم السند</th><th>لمن المساعدة</th><th>أحضرت بواسطة آخر؟</th><th>اسم الوسيط</th><th>تاريخ التسجيل</th><th>الحالة</th><th>إجراءات</th></tr>
                        </thead>
                        <tbody id="sacrificesTableBody"></tbody>
                    </table>
                </div><hr>
            </div>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, where, doc, updateDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAOV5iF6t5kdAeBIZPNcmINB4Ya66Yx9Pg",
        authDomain: "adahi-app.firebaseapp.com",
        projectId: "adahi-app",
        storageBucket: "adahi-app.firebasestorage.app",
        messagingSenderId: "42370235858",
        appId: "1:42370235858:web:6f839b92404afafdae9c0b",
        measurementId: "G-1T2TGPK72K"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const loginSection = document.getElementById('loginSection');
      const dataEntrySection = document.getElementById('dataEntrySection');
      const adminViewSection = document.getElementById('adminViewSection');
      const userDataViewSection = document.getElementById('userDataViewSection');
      const loginForm = document.getElementById('loginForm');
      const logoutButton = document.getElementById('logoutButton');
      const hrAfterLogout = document.getElementById('hrAfterLogout');
      const authStatus = document.getElementById('authStatus');
      const ADMIN_UID = 'AKpJLStGGnRC2Albb8bpZ0KtTGq1';

      const wantsPortionYesRadio = document.getElementById('wantsPortionYes');
      const wantsPortionNoRadio = document.getElementById('wantsPortionNo');
      const portionDetailsDiv = document.getElementById('portionDetailsDiv');
      const addressFieldDiv = document.getElementById('addressFieldDiv');
      const paymentDoneYesRadio = document.getElementById('paymentDoneYes');
      const paymentDoneNoRadio = document.getElementById('paymentDoneNo');
      const paymentDetailsDiv = document.getElementById('paymentDetailsDiv');
      const broughtByOtherYesRadio = document.getElementById('broughtByOtherYes');
      const broughtByOtherNoRadio = document.getElementById('broughtByOtherNo');
      const broughtByOtherNameDiv = document.getElementById('broughtByOtherNameDiv');
      const exportAllToCsvButton = document.getElementById('exportAllToCsvButton');
      const exportAllUsersSeparateCsvButton = document.getElementById('exportAllUsersSeparateCsvButton');


      wantsPortionYesRadio.addEventListener('change', function() {if (this.checked) {portionDetailsDiv.style.display = 'block';addressFieldDiv.style.display = 'block';} else {portionDetailsDiv.style.display = 'none';addressFieldDiv.style.display = 'none'; document.getElementById('portionDetails').value = ''; document.getElementById('address').value = '';}});
      wantsPortionNoRadio.addEventListener('change', function() {if (this.checked) {portionDetailsDiv.style.display = 'none';addressFieldDiv.style.display = 'none'; document.getElementById('portionDetails').value = ''; document.getElementById('address').value = '';}});
      paymentDoneYesRadio.addEventListener('change', function() {if (this.checked) {paymentDetailsDiv.style.display = 'block';} else {paymentDetailsDiv.style.display = 'none'; document.getElementById('receiptBookNumber').value = ''; document.getElementById('receiptNumber').value = '';}});
      paymentDoneNoRadio.addEventListener('change', function() {if (this.checked) {paymentDetailsDiv.style.display = 'none'; document.getElementById('receiptBookNumber').value = ''; document.getElementById('receiptNumber').value = '';}});
      broughtByOtherYesRadio.addEventListener('change', function() { if (this.checked) { broughtByOtherNameDiv.style.display = 'block'; } else { broughtByOtherNameDiv.style.display = 'none'; document.getElementById('broughtByOtherName').value = '';}});
      broughtByOtherNoRadio.addEventListener('change', function() { if (this.checked) { broughtByOtherNameDiv.style.display = 'none'; document.getElementById('broughtByOtherName').value = ''; }});

      const adahiForm = document.getElementById('adahiForm');
      const statusMessage = document.getElementById('statusMessage');
      const dataEntrySectionH2 = dataEntrySection.querySelector('h2');
      const adahiFormSubmitButton = adahiForm.querySelector('button[type="submit"]');
      let editingDocId = null;

      function resetFormToEntryMode() {
          adahiForm.reset();
          editingDocId = null;
          dataEntrySectionH2.textContent = 'تسجيل أضحية/تبرع جديد';
          adahiFormSubmitButton.textContent = 'تسجيل البيانات';
          adahiFormSubmitButton.style.backgroundColor = '#27ae60';
          portionDetailsDiv.style.display = 'none'; addressFieldDiv.style.display = 'none';
          paymentDetailsDiv.style.display = 'none'; broughtByOtherNameDiv.style.display = 'none';
          document.getElementById('wantsToAttendNo').checked = true;
          document.getElementById('wantsPortionNo').checked = true;
          document.getElementById('paymentDoneNo').checked = true;
          document.getElementById('broughtByOtherNo').checked = true;
          const cancelButton = adahiForm.querySelector('#cancelEditButton');
          if (cancelButton) { cancelButton.style.display = 'none'; }
      }

      function populateFormForEdit(docId, data) {
          editingDocId = docId;
          dataEntrySectionH2.textContent = 'تعديل بيانات الأضحية';
          adahiFormSubmitButton.textContent = 'حفظ التعديلات';
          adahiFormSubmitButton.style.backgroundColor = '#f39c12';
          document.getElementById('donorName').value = data.donorName || '';
          document.getElementById('sacrificeFor').value = data.sacrificeFor || '';
          document.getElementById(data.wantsToAttend ? 'wantsToAttendYes' : 'wantsToAttendNo').checked = true;
          document.getElementById('phoneNumber').value = data.phoneNumber || '';
          document.getElementById(data.wantsPortion ? 'wantsPortionYes' : 'wantsPortionNo').checked = true;
          wantsPortionYesRadio.dispatchEvent(new Event('change'));
          if (data.wantsPortion) { document.getElementById('portionDetails').value = data.portionDetails || ''; document.getElementById('address').value = data.address || '';}
          document.getElementById(data.paymentDone ? 'paymentDoneYes' : 'paymentDoneNo').checked = true;
          paymentDoneYesRadio.dispatchEvent(new Event('change'));
          if (data.paymentDone) { document.getElementById('receiptBookNumber').value = data.receiptBookNumber || ''; document.getElementById('receiptNumber').value = data.receiptNumber || '';}
          document.getElementById('assistanceFor').value = data.assistanceFor || 'inside_ramtha';
          document.getElementById(data.broughtByOther ? 'broughtByOtherYes' : 'broughtByOtherNo').checked = true;
          broughtByOtherYesRadio.dispatchEvent(new Event('change'));
          if (data.broughtByOther) { document.getElementById('broughtByOtherName').value = data.broughtByOtherName || '';}
          let cancelButton = adahiForm.querySelector('#cancelEditButton');
          if (!cancelButton) {
              cancelButton = document.createElement('button'); cancelButton.type = 'button'; cancelButton.id = 'cancelEditButton'; cancelButton.textContent = 'إلغاء التعديل';
              cancelButton.style.backgroundColor = '#e74c3c'; cancelButton.style.marginRight = '10px';
              cancelButton.onclick = resetFormToEntryMode;
              adahiFormSubmitButton.parentNode.insertBefore(cancelButton, adahiFormSubmitButton);
          }
          cancelButton.style.display = 'inline-block';
          dataEntrySection.scrollIntoView({ behavior: 'smooth' });
          statusMessage.textContent = `جاري تعديل: ${data.donorName || 'سجل'}. مرجع: ${docId}`; statusMessage.className = '';
      }

      adahiForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const currentUser = auth.currentUser;
          if (!currentUser) { statusMessage.textContent = 'يجب تسجيل الدخول.'; statusMessage.className = 'error'; return; }
          const donorName = document.getElementById('donorName').value;
          const sacrificeFor = document.getElementById('sacrificeFor').value;
          const wantsToAttend = document.querySelector('input[name="wantsToAttend"]:checked').value;
          const phoneNumber = document.getElementById('phoneNumber').value;
          const wantsPortion = document.querySelector('input[name="wantsPortion"]:checked').value;
          let portionDetails = wantsPortion === 'yes' ? document.getElementById('portionDetails').value : '';
          let address = wantsPortion === 'yes' ? document.getElementById('address').value : '';
          const paymentDone = document.querySelector('input[name="paymentDone"]:checked').value;
          let receiptBookNumber = paymentDone === 'yes' ? document.getElementById('receiptBookNumber').value : '';
          let receiptNumber = paymentDone === 'yes' ? document.getElementById('receiptNumber').value : '';
          const assistanceFor = document.getElementById('assistanceFor').value;
          const broughtByOther = document.querySelector('input[name="broughtByOther"]:checked').value;
          let broughtByOtherName = broughtByOther === 'yes' ? document.getElementById('broughtByOtherName').value : '';
          const adahiDataToSave = {
              donorName, sacrificeFor, wantsToAttend: wantsToAttend === 'yes', phoneNumber,
              wantsPortion: wantsPortion === 'yes', portionDetails, address,
              paymentDone: paymentDone === 'yes', receiptBookNumber, receiptNumber,
              assistanceFor, broughtByOther: broughtByOther === 'yes', broughtByOtherName,
          };
          if (editingDocId) {
              statusMessage.textContent = 'جاري التحديث...'; statusMessage.className = '';
              try {
                  const docRef = doc(db, "sacrifices", editingDocId);
                  await updateDoc(docRef, { ...adahiDataToSave, lastUpdatedAt: serverTimestamp() });
                  statusMessage.textContent = 'تم التحديث بنجاح!'; statusMessage.className = 'success';
                  resetFormToEntryMode();
              } catch (e) { statusMessage.textContent = 'خطأ تحديث: ' + e.message; statusMessage.className = 'error';}
          } else {
              statusMessage.textContent = 'جاري الحفظ...'; statusMessage.className = '';
              adahiDataToSave.userId = currentUser.uid;
              adahiDataToSave.status = 'pending_entry';
              adahiDataToSave.createdAt = serverTimestamp();
              try {
                  const docRefDb = await addDoc(collection(db, "sacrifices"), adahiDataToSave);
                  statusMessage.textContent = 'تم الحفظ بنجاح! مرجع: ' + docRefDb.id; statusMessage.className = 'success';
                  resetFormToEntryMode();
              } catch (e) { statusMessage.textContent = 'خطأ حفظ: ' + e.message; statusMessage.className = 'error';}
          }
      });

      const sacrificesTableBody = document.getElementById('sacrificesTableBody');
      const loadingMessage = document.getElementById('loadingMessage');
      function formatFirestoreTimestamp(timestamp) { if (!timestamp || !timestamp.toDate) {return 'غير متوفر';} const date = timestamp.toDate(); return date.toLocaleString('ar-EG', {year: 'numeric', month: 'short', day: 'numeric',hour: '2-digit', minute: '2-digit'});}

      function renderSacrificesForAdmin(docs) {
          sacrificesTableBody.innerHTML = '';
          if (docs.empty) { loadingMessage.textContent = 'لا توجد بيانات.'; loadingMessage.style.display = 'block'; sacrificesTableBody.innerHTML = '<tr><td colspan="17">لا توجد بيانات.</td></tr>'; return; }
          loadingMessage.style.display = 'none';
          let counter = 1;
          docs.forEach((docSnapshot) => {
              const data = docSnapshot.data(); const row = sacrificesTableBody.insertRow();
              row.insertCell().textContent = counter++; row.insertCell().textContent = data.donorName || '';
              row.insertCell().textContent = data.sacrificeFor || ''; row.insertCell().textContent = data.wantsToAttend ? 'نعم' : 'لا';
              row.insertCell().textContent = data.phoneNumber || ''; row.insertCell().textContent = data.wantsPortion ? 'نعم' : 'لا';
              row.insertCell().textContent = data.portionDetails || ''; row.insertCell().textContent = data.address || '';
              row.insertCell().textContent = data.paymentDone ? 'نعم' : 'لا'; row.insertCell().textContent = data.receiptBookNumber || '';
              row.insertCell().textContent = data.receiptNumber || '';
              row.insertCell().textContent = data.assistanceFor ? (data.assistanceFor === 'inside_ramtha' ? 'داخل الرمثا' : data.assistanceFor === 'gaza_people' ? 'لأهل غزة' : data.assistanceFor === 'for_himself' ? 'لنفسه' : data.assistanceFor) : '';
              row.insertCell().textContent = data.broughtByOther ? 'نعم' : 'لا'; row.insertCell().textContent = data.broughtByOtherName || '';
              row.insertCell().textContent = formatFirestoreTimestamp(data.createdAt);
              let statusText = data.status;
              if (data.status === 'pending_entry') { statusText = 'لم تدخل بعد'; }
              else if (data.status === 'entered') { statusText = 'تم الإدخال'; }
              else if (data.status === 'approved' || data.status === 'pending_approval' || data.status === 'rejected') { statusText = `(${statusText}) غير مستخدم`;}
              row.insertCell().textContent = statusText;
              const actionsCell = row.insertCell();
              if (data.status === 'pending_entry') {
                  const confirmButton = document.createElement('button'); confirmButton.textContent = 'تأكيد الإدخال';
                  confirmButton.onclick = () => updateSacrificeStatus(docSnapshot.id, 'entered'); actionsCell.appendChild(confirmButton);
              } else if (data.status === 'entered') {
                  const revertButton = document.createElement('button'); revertButton.textContent = "إعادة لـ 'لم تدخل بعد'";
                  revertButton.style.backgroundColor = '#f39c12';
                  revertButton.onclick = () => { updateSacrificeStatus(docSnapshot.id, 'pending_entry'); }; actionsCell.appendChild(revertButton);
              }
              const editButton = document.createElement('button'); editButton.textContent = 'تعديل'; editButton.style.backgroundColor = '#5dade2'; editButton.style.marginLeft = '5px'; editButton.onclick = () => populateFormForEdit(docSnapshot.id, data); actionsCell.appendChild(editButton);
              const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'حذف'; deleteBtn.className = 'delete-btn'; deleteBtn.style.marginLeft = '5px'; deleteBtn.onclick = () => deleteSacrifice(docSnapshot.id, data.donorName || 'هذا السجل'); actionsCell.appendChild(deleteBtn);
          });
      }
      async function updateSacrificeStatus(docId, newStatus) { const sacrificeRef = doc(db, "sacrifices", docId); try { await updateDoc(sacrificeRef, { status: newStatus, lastUpdatedAt: serverTimestamp() }); } catch (error) { alert('خطأ تحديث الحالة: ' + error.message); } }
      async function deleteSacrifice(docId, donorNameToConfirm) { if (confirm(`هل أنت متأكد من حذف: ${donorNameToConfirm}؟`)) { const sacrificeRef = doc(db, "sacrifices", docId); try { await deleteDoc(sacrificeRef); statusMessage.textContent = `تم حذف "${donorNameToConfirm}" بنجاح.`; statusMessage.className = 'success'; setTimeout(() => { statusMessage.textContent = ''; statusMessage.className = ''; }, 3000); } catch (error) { alert('خطأ حذف: ' + error.message); statusMessage.textContent = 'خطأ حذف.'; statusMessage.className = 'error'; } } }

      function fetchAndRenderSacrificesForAdmin(statusFilter = null) {
          loadingMessage.textContent = 'جاري تحميل البيانات...'; loadingMessage.style.display = 'block'; sacrificesTableBody.innerHTML = '';
          let q;
          if (statusFilter) { q = query(collection(db, "sacrifices"), where("status", "==", statusFilter), orderBy("createdAt", "desc")); }
          else { q = query(collection(db, "sacrifices"), orderBy("createdAt", "desc")); }
          onSnapshot(q, (querySnapshot) => { renderSacrificesForAdmin(querySnapshot); },
          (error) => { console.error("Error fetching admin docs:", error); sacrificesTableBody.innerHTML = `<tr><td colspan="17">خطأ تحميل البيانات.</td></tr>`; });
      }
      if(document.getElementById('filterPending')) document.getElementById('filterPending').addEventListener('click', () => fetchAndRenderSacrificesForAdmin('pending_entry'));
      if(document.getElementById('filterEntered')) document.getElementById('filterEntered').addEventListener('click', () => fetchAndRenderSacrificesForAdmin('entered'));
      if(document.getElementById('filterAll')) document.getElementById('filterAll').addEventListener('click', () => fetchAndRenderSacrificesForAdmin(null));

      const userSacrificesTableBody = document.getElementById('userSacrificesTableBody');
      const userLoadingMessage = document.getElementById('userLoadingMessage');
      let unsubscribeUserSacrifices = null;

      function renderSacrificesForUser(docs) {
          userSacrificesTableBody.innerHTML = '';
          if (docs.empty) { userLoadingMessage.textContent = 'لا توجد تسجيلات.'; userLoadingMessage.style.display = 'block'; userSacrificesTableBody.innerHTML = '<tr><td colspan="7">لا توجد تسجيلات.</td></tr>'; return; }
          userLoadingMessage.style.display = 'none'; let counter = 1;
          docs.forEach((docSnapshot) => {
              const data = docSnapshot.data(); const row = userSacrificesTableBody.insertRow();
              row.insertCell().textContent = counter++; row.insertCell().textContent = data.donorName || '';
              row.insertCell().textContent = data.sacrificeFor || '';
              row.insertCell().textContent = data.broughtByOther ? 'نعم' : 'لا'; row.insertCell().textContent = data.broughtByOtherName || '';
              row.insertCell().textContent = formatFirestoreTimestamp(data.createdAt);
              let statusText = data.status;
              if (data.status === 'pending_entry') { statusText = 'لم تدخل بعد'; }
              else if (data.status === 'entered') { statusText = 'تم الإدخال'; }
              else if (data.status === 'approved' || data.status === 'pending_approval' || data.status === 'rejected') { statusText = `(${statusText}) غير مستخدم`;}
              row.insertCell().textContent = statusText;
          });
      }

      function fetchAndRenderSacrificesForUser(userId) { if (unsubscribeUserSacrifices) { unsubscribeUserSacrifices(); unsubscribeUserSacrifices = null; } const q = query(collection(db, "sacrifices"), where("userId", "==", userId), orderBy("createdAt", "desc")); unsubscribeUserSacrifices = onSnapshot(q, (querySnapshot) => {renderSacrificesForUser(querySnapshot);}, (error) => { userSacrificesTableBody.innerHTML = `<tr><td colspan="7">خطأ تحميل.</td></tr>`;});}
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
            authStatus.textContent = `مرحباً بك`; // Corrected welcome message
            authStatus.className = 'success'; loginSection.style.display = 'none'; logoutButton.style.display = 'inline-block';
            hrAfterLogout.style.display = 'block'; dataEntrySection.style.display = 'block';
            resetFormToEntryMode();
            if (user.uid === ADMIN_UID) {
                if (unsubscribeUserSacrifices) { unsubscribeUserSacrifices(); unsubscribeUserSacrifices = null; }
                adminViewSection.style.display = 'block'; userDataViewSection.style.display = 'none';
                fetchAndRenderSacrificesForAdmin(null);
            } else {
                adminViewSection.style.display = 'none';userDataViewSection.style.display = 'block';
                fetchAndRenderSacrificesForUser(user.uid);
            }
        } else {
            if (unsubscribeUserSacrifices) { unsubscribeUserSacrifices(); unsubscribeUserSacrifices = null; }
            resetFormToEntryMode();
            authStatus.textContent = 'يرجى تسجيل الدخول للوصول.'; authStatus.className = '';
            loginSection.style.display = 'block'; dataEntrySection.style.display = 'none';
            adminViewSection.style.display = 'none'; userDataViewSection.style.display = 'none';
            logoutButton.style.display = 'none'; hrAfterLogout.style.display = 'none';
            if (sacrificesTableBody) sacrificesTableBody.innerHTML = '';
            if (userSacrificesTableBody) userSacrificesTableBody.innerHTML = '';
        }
      });

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          authStatus.textContent = 'جاري التحقق...'; authStatus.className = '';
          const usernameOrEmailInput = document.getElementById('usernameInput').value;
          const password = document.getElementById('passwordInput').value;
          const rememberMe = document.getElementById('rememberMe').checked;
          const persistenceMode = rememberMe ? browserLocalPersistence : browserSessionPersistence;

          try {
            await setPersistence(auth, persistenceMode);
            try {
                const userCredential = await signInWithEmailAndPassword(auth, usernameOrEmailInput, password);
                return; // onAuthStateChanged will handle the rest
            } catch (emailSignInError) {
                if (emailSignInError.code === 'auth/invalid-email' || emailSignInError.code === 'auth/invalid-credential') {
                    try {
                        const usersMapRef = collection(db, "user_credentials_map");
                        const q = query(usersMapRef, where("username", "==", usernameOrEmailInput));
                        const querySnapshot = await getDocs(q);
                        if (querySnapshot.empty) { authStatus.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.'; authStatus.className = 'error'; return; }
                        let foundUserEmail = null;
                        querySnapshot.forEach((doc) => { foundUserEmail = doc.data().email; });
                        if (foundUserEmail) {
                            if (!foundUserEmail || typeof foundUserEmail !== 'string' || !foundUserEmail.includes('@')) { authStatus.textContent = 'البريد المرتبط باسم المستخدم غير صالح.'; authStatus.className = 'error'; return; }
                            await signInWithEmailAndPassword(auth, foundUserEmail, password);
                            // No need to store username in session, onAuthStateChanged now has generic welcome
                        } else { authStatus.textContent = 'لم يتم العثور على بريد إلكتروني مطابق لاسم المستخدم.'; authStatus.className = 'error'; }
                    } catch (lookupError) {
                        let errorMsg = 'خطأ في البحث عن المستخدم أو كلمة المرور.';
                        if (lookupError.code === 'auth/invalid-credential') { errorMsg = 'كلمة المرور غير صحيحة لاسم المستخدم المقدم.'; }
                        else if (lookupError.code === 'auth/invalid-email') { errorMsg = 'البريد الإلكتروني المرتبط باسم المستخدم غير صالح.'; }
                        else if (lookupError.code === 'permission-denied') { errorMsg = 'خطأ في صلاحيات البحث عن المستخدم.'; }
                        authStatus.textContent = errorMsg; authStatus.className = 'error';
                    }
                } else { authStatus.textContent = `خطأ في تسجيل الدخول: ${emailSignInError.message}`; authStatus.className = 'error'; }
            }
          } catch (persistenceError) { console.error("Error setting auth persistence: ", persistenceError); authStatus.textContent = 'خطأ في إعداد جلسة الدخول.'; authStatus.className = 'error'; }
        });
      }

      if (logoutButton) { logoutButton.addEventListener('click', () => { signOut(auth).catch((error) => { authStatus.textContent = `خطأ في تسجيل الخروج: ${error.message}`; authStatus.className = 'error'; }); });}
      
      function downloadCSV(csvContent, filename) {
          const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute("href", url);
              link.setAttribute("download", filename);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
          }
      }

      function convertToCSV(dataArray, headerKeys, displayHeaders) {
          const array = [displayHeaders.join(',')].concat(
              dataArray.map(obj => headerKeys.map(key => {
                  let cell = obj[key] === null || obj[key] === undefined ? '' : obj[key];
                  if (typeof cell === 'boolean') { cell = cell ? 'نعم' : 'لا'; }
                  else if (key === 'status') {
                      if (cell === 'pending_entry') cell = 'لم تدخل بعد';
                      else if (cell === 'entered') cell = 'تم الإدخال';
                      else if (cell === 'approved' || cell === 'pending_approval' || cell === 'rejected') cell = `(${cell}) غير مستخدم`;
                  } else if (key === 'assistanceFor') {
                      if (cell === 'inside_ramtha') cell = 'داخل الرمثا';
                      else if (cell === 'gaza_people') cell = 'لأهل غزة';
                      else if (cell === 'for_himself') cell = 'لنفسه';
                  }
                  if (typeof cell === 'string' && cell.includes(',')) { cell = `"${cell.replace(/"/g, '""')}"`; }
                  return cell;
              }).join(','))
          );
          return array.join('\r\n');
      }

      if (exportAllToCsvButton) {
          exportAllToCsvButton.addEventListener('click', async () => {
              statusMessage.textContent = "جاري تجهيز البيانات..."; statusMessage.className = '';
              try {
                  const q = query(collection(db, "sacrifices"), orderBy("createdAt", "desc"));
                  const querySnapshot = await getDocs(q);
                  if (querySnapshot.empty) { statusMessage.textContent = "لا توجد بيانات."; statusMessage.className = 'error'; return; }
                  const allData = [];
                  querySnapshot.forEach(doc => {
                      const data = doc.data();
                      allData.push({
                          docId: doc.id, donorName: data.donorName, sacrificeFor: data.sacrificeFor,
                          wantsToAttend: data.wantsToAttend, phoneNumber: data.phoneNumber, wantsPortion: data.wantsPortion,
                          portionDetails: data.portionDetails, address: data.address, paymentDone: data.paymentDone,
                          receiptBookNumber: data.receiptBookNumber, receiptNumber: data.receiptNumber,
                          assistanceFor: data.assistanceFor, broughtByOther: data.broughtByOther,
                          broughtByOtherName: data.broughtByOtherName,
                          createdAt: data.createdAt ? formatFirestoreTimestamp(data.createdAt) : '',
                          status: data.status, userId: data.userId
                      });
                  });
                  const headerKeys = ["docId", "donorName", "sacrificeFor", "wantsToAttend", "phoneNumber", "wantsPortion", "portionDetails", "address", "paymentDone", "receiptBookNumber", "receiptNumber", "assistanceFor", "broughtByOther", "broughtByOtherName", "createdAt", "status", "userId"];
                  const displayHeaders = ["معرف السجل", "اسم المتبرع", "الأضحية عن", "يريد الحضور", "رقم الهاتف", "يريد جزءًا", "تفاصيل الجزء", "العنوان", "تم الدفع", "رقم الدفتر", "رقم السند", "لمن المساعدة", "أحضرت بواسطة آخر", "اسم الوسيط", "تاريخ التسجيل", "الحالة", "معرف المستخدم"];
                  const csvContent = convertToCSV(allData, headerKeys, displayHeaders);
                  downloadCSV(csvContent, 'كل_بيانات_الاضاحي.csv');
                  statusMessage.textContent = "تم التصدير بنجاح."; statusMessage.className = 'success';
              } catch (error) { console.error("Error exporting all data: ", error); statusMessage.textContent = "خطأ تصدير: " + error.message; statusMessage.className = 'error'; }
          });
      }

      if (exportAllUsersSeparateCsvButton) {
          exportAllUsersSeparateCsvButton.addEventListener('click', async () => {
              statusMessage.textContent = "جاري تجهيز بيانات كل مستخدم..."; statusMessage.className = '';
              try {
                  const q = query(collection(db, "sacrifices"), orderBy("userId"), orderBy("createdAt", "desc")); // Order by userId first
                  const querySnapshot = await getDocs(q);
                  if (querySnapshot.empty) { statusMessage.textContent = "لا توجد بيانات لتصديرها."; statusMessage.className = 'error'; return; }
                  
                  const dataByUser = {};
                  querySnapshot.forEach(doc => {
                      const data = doc.data();
                      if (!data.userId) return; // Skip if no userId
                      if (!dataByUser[data.userId]) {
                          dataByUser[data.userId] = [];
                      }
                      dataByUser[data.userId].push({
                          docId: doc.id, donorName: data.donorName, sacrificeFor: data.sacrificeFor,
                          wantsToAttend: data.wantsToAttend, phoneNumber: data.phoneNumber, wantsPortion: data.wantsPortion,
                          portionDetails: data.portionDetails, address: data.address, paymentDone: data.paymentDone,
                          receiptBookNumber: data.receiptBookNumber, receiptNumber: data.receiptNumber,
                          assistanceFor: data.assistanceFor, broughtByOther: data.broughtByOther,
                          broughtByOtherName: data.broughtByOtherName,
                          createdAt: data.createdAt ? formatFirestoreTimestamp(data.createdAt) : '',
                          status: data.status
                      });
                  });

                  if (Object.keys(dataByUser).length === 0) {
                      statusMessage.textContent = "لم يتم العثور على بيانات مع معرفات مستخدمين صالحة."; statusMessage.className = 'error'; return;
                  }

                  const headerKeys = ["docId", "donorName", "sacrificeFor", "wantsToAttend", "phoneNumber", "wantsPortion", "portionDetails", "address", "paymentDone", "receiptBookNumber", "receiptNumber", "assistanceFor", "broughtByOther", "broughtByOtherName", "createdAt", "status"];
                  const displayHeaders = ["معرف السجل", "اسم المتبرع", "الأضحية عن", "يريد الحضور", "رقم الهاتف", "يريد جزءًا", "تفاصيل الجزء", "العنوان", "تم الدفع", "رقم الدفتر", "رقم السند", "لمن المساعدة", "أحضرت بواسطة آخر", "اسم الوسيط", "تاريخ التسجيل", "الحالة"];
                  
                  let exportedCount = 0;
                  for (const userId in dataByUser) {
                      if (dataByUser.hasOwnProperty(userId)) {
                          const userData = dataByUser[userId];
                          const csvContent = convertToCSV(userData, headerKeys, displayHeaders);
                          // تأخير بسيط بين التنزيلات لتجنب حظر المتصفح للعديد من التنزيلات السريعة
                          await new Promise(resolve => setTimeout(resolve, 300));
                          downloadCSV(csvContent, `بيانات_مستخدم_${userId}.csv`);
                          exportedCount++;
                      }
                  }
                  statusMessage.textContent = `تم تصدير بيانات ${exportedCount} مستخدم بنجاح في ملفات منفصلة.`; statusMessage.className = 'success';

              } catch (error) {
                  console.error("Error exporting all users separate data: ", error);
                  // Check if error is due to missing index for orderBy("userId")
                  if (error.code === 'failed-precondition' && error.message.includes('index')) {
                       statusMessage.textContent = "خطأ: يتطلب هذا التصدير فهرسًا مركبًا. يرجى التحقق من وحدة التحكم في Firebase لإنشاء الفهرس: userId (تصاعدي), createdAt (تنازلي).";
                  } else {
                       statusMessage.textContent = "خطأ أثناء تصدير بيانات المستخدمين: " + error.message;
                  }
                  statusMessage.className = 'error';
              }
          });
      }

    </script>
</body>
</html>
